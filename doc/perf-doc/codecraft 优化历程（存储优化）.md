

# codecraft 优化历程（存储优化）



## 一、存储空间优化

### 1.1 文件清理机制

需求：**每天**清理所有无用的文件，**包括**用户上传的模板制作文件（`generator_make_template`）、已删除的代码生成器对应的产物包文件（`generator_dist`）。

方案设计，考虑两个问题：

1. 如何触发任务的定时执行？
2. 如何高效删除文件

对于问题一，可以通过定时任务实现，比如 Spring Scheduler。但如果将项目同时部署到多个服务器上，同一时间每个机器都会触发定时任务，会导致重复执行和可能的冲突。所以我们写定时任务的时候，尽量兼容分布式场景，同一时间只有一个任务执行。比如：

1. 分布式锁
2. 限定指定机器执行
3. 分布式任务调度系统 ✅ （XXL-Job）

对于问题二，一个个删除的性能往往是很低的，要多次请求对象存储，所以选用批量删除的方式。

1. 对于用户上传的模板制作文件，可以整体删除模板制作文件目录
2. 对于代码生成求对应的产物包文件，先找到要清理的文件列表，然后进行批量删除

> TODO:
>
> 定时批量删除的问题解决，比如刚上传就删除了。

